import{a as d,j as e,C as f}from"./index-C6mMUq5w.js";import{a as g}from"./index-xsH4HHeE.js";import{a as C}from"./index-CjQjypWB.js";import{C as U,a as A}from"./CRow-B8XJxCvJ.js";import{C as S,a as _}from"./CCardBody-gDBQUuD8.js";import{C as B}from"./CCardHeader-D174EtRf.js";import{C as D}from"./CCardTitle-DOZAZvAL.js";import{C as L,a as F,b as p,c as m,d as M,e as i}from"./CTable-Bo38vagw.js";import{a as z}from"./index.esm-BFnYFe3D.js";const O="https://be-mirai.valla.cloud/api/company/tkd",I=a=>`https://be-mirai.valla.cloud/api/adm/usr/paymentid/${a}`,v="https://be-mirai.valla.cloud/api/adm/usr/viewPDF",G="tbl_pembayaran",k="bukti_pembayaran",V=a=>{if(!a)return!1;if(typeof a=="object"){if(Array.isArray(a.data))return a.data.length>0;if("type"in a&&a.type==="Buffer")return!0}return!!a},$=a=>{if(a==null||a===""||isNaN(Number(a)))return"-";try{return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0}).format(Number(a))}catch{return String(a)}},ee=()=>{const[a,N]=d.useState([]),[w,T]=d.useState(!0),[E,P]=d.useState({}),[b,x]=d.useState(null);d.useEffect(()=>{(async()=>{var r;try{const t=C.get("login"),o=((r=(await g.get(O,{headers:{Authorization:`Bearer ${t}`}})).data)==null?void 0:r.data)||[];N(o);const c=(await Promise.all(o.map(async l=>{var u;try{const n=((u=(await g.get(I(l.userid),{headers:{Authorization:`Bearer ${t}`}})).data)==null?void 0:u.data)||{};return[l.userid,{bukti:V(n==null?void 0:n[k]),nominal:(n==null?void 0:n.nominal_pembayaran)??null,keterangan:(n==null?void 0:n.keterangan)??""}]}catch{return[l.userid,{bukti:!1,nominal:null,keterangan:""}]}}))).reduce((l,[u,j])=>(l[u]=j,l),{});P(c)}catch(t){console.error("Gagal mengambil data:",t)}finally{T(!1)}})()},[]);const R=async s=>{try{x(s);const r=C.get("login"),t=await fetch(v,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json",Accept:"application/pdf"},body:JSON.stringify({userid:s,columns:k,table:G})}),y=t.headers.get("content-type")||"";if(!t.ok&&y.includes("application/json")){const c=await t.json().catch(()=>({}));throw new Error((c==null?void 0:c.message)||"Gagal memuat bukti pembayaran")}const o=await t.blob();if(o.size===0)throw new Error("File kosong / tidak ditemukan");const h=URL.createObjectURL(o);window.open(h,"_blank","noopener,noreferrer"),setTimeout(()=>URL.revokeObjectURL(h),6e4)}catch(r){alert((r==null?void 0:r.message)||"Tidak dapat membuka bukti pembayaran"),console.error("viewPDF error:",r)}finally{x(null)}};return e.jsx(U,{children:e.jsx(A,{xs:12,children:e.jsxs(S,{children:[e.jsx(B,{children:e.jsx(D,{children:"Data Pembayaran"})}),e.jsx(_,{children:e.jsxs(L,{responsive:!0,hover:!0,children:[e.jsx(F,{children:e.jsxs(p,{children:[e.jsx(m,{style:{width:60},children:"No"}),e.jsx(m,{children:"Nama"}),e.jsx(m,{style:{width:180},children:"Bukti Pembayaran"}),e.jsx(m,{style:{width:200},children:"Nominal Pembayaran"}),e.jsx(m,{children:"Keterangan"})]})}),e.jsx(M,{children:w?e.jsx(p,{children:e.jsx(i,{colSpan:5,children:e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(f,{size:"sm"})," ",e.jsx("span",{children:"Memuat data…"})]})})}):a.length===0?e.jsx(p,{children:e.jsx(i,{colSpan:5,className:"text-center text-muted",children:"Tidak ada data"})}):a.map((s,r)=>{const t=E[s.userid]||{};return e.jsxs(p,{children:[e.jsx(i,{children:r+1}),e.jsx(i,{children:s.nama}),e.jsx(i,{children:t.bukti?e.jsx(z,{size:"sm",color:"info",disabled:b===s.userid,onClick:()=>R(s.userid),children:b===s.userid?e.jsxs(e.Fragment,{children:[e.jsx(f,{size:"sm",className:"me-2"}),"Membuka…"]}):"View"}):e.jsx("span",{className:"text-danger",children:"Belum diupload"})}),e.jsx(i,{children:$(t.nominal)}),e.jsx(i,{className:"text-break",children:t.keterangan||"-"})]},s.userid)})})]})})]})})})};export{ee as default};
