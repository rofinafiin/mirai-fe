import{x as N,q as E,a as o,j as a,C as w}from"./index-C6mMUq5w.js";import{a as b}from"./index-CjQjypWB.js";import{S as c}from"./sweetalert2.esm.all-89IKscqO.js";import{C as L,a as P}from"./CCardBody-gDBQUuD8.js";import{C as T}from"./CCardHeader-D174EtRf.js";import{C as d,a as l}from"./CRow-B8XJxCvJ.js";import{C as _}from"./CCardTitle-DOZAZvAL.js";import{a as m}from"./index.esm-BFnYFe3D.js";import{C as V}from"./CForm-DOp7Y24-.js";import{C as A}from"./CFormLabel-CZasDc-G.js";import{C as B}from"./CFormSelect-JH-6Ev9o.js";import"./CFormControlWrapper-BFmmxZq2.js";import"./CFormControlValidation-CP5S10L1.js";import"./CFormText-baHXDdj0.js";const F="https://be-mirai.valla.cloud/api/adm/usr/viewPDF",R="tbl_pembayaran",O="bukti_pembayaran",U=s=>`https://be-mirai.valla.cloud/api/adm/usr/paymentid/${s}`,z="https://be-mirai.valla.cloud/api/adm/usr/payment/validasi",aa=()=>{const{user_id:s}=N(),u=E(),[h,x]=o.useState(""),[y,g]=o.useState(!1),[p,k]=o.useState(!0),[j,C]=o.useState(!1);o.useEffect(()=>{(async()=>{try{const e=b.get("login"),n=await fetch(U(s),{headers:{Authorization:`Bearer ${e}`}});if(!n.ok)throw new Error("Gagal mengambil data pembayaran");const i=await n.json(),r=(i==null?void 0:i.data)||{};r.validasi&&x(String(r.validasi))}catch(e){console.warn("Fetch payment current failed:",e)}finally{k(!1)}})()},[s]);const v=async()=>{try{g(!0);const t=b.get("login"),e=await fetch(F,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json",Accept:"application/pdf"},body:JSON.stringify({userid:s,columns:O,table:R})}),n=e.headers.get("content-type")||"";if(!e.ok&&n.includes("application/json")){const f=await e.json().catch(()=>({}));throw new Error((f==null?void 0:f.message)||"Gagal memuat bukti pembayaran")}const i=await e.blob();if(i.size===0)throw new Error("File kosong / tidak ditemukan");const r=URL.createObjectURL(i);window.open(r,"_blank","noopener,noreferrer"),setTimeout(()=>URL.revokeObjectURL(r),6e4)}catch(t){c.fire({icon:"error",title:"Gagal membuka",text:(t==null?void 0:t.message)||"Tidak dapat membuka bukti pembayaran."})}finally{g(!1)}},S=async t=>{if(t.preventDefault(),!h){c.fire({icon:"warning",title:"Pilih status validasi dulu"});return}try{C(!0);const e=b.get("login"),n=await fetch(z,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({userid:s,validasi:h})});if(!n.ok){const i=await n.json().catch(()=>({}));throw new Error((i==null?void 0:i.message)||"Gagal menyimpan validasi")}await c.fire({icon:"success",title:"Berhasil",text:"Validasi pembayaran berhasil disimpan.",timer:1500,showConfirmButton:!1}),u("/admin")}catch(e){c.fire({icon:"error",title:"Gagal menyimpan",text:(e==null?void 0:e.message)||"Terjadi kesalahan saat menyimpan validasi."})}finally{C(!1)}};return a.jsxs(L,{children:[a.jsx(T,{children:a.jsxs(d,{className:"align-items-center",children:[a.jsx(l,{children:a.jsxs(_,{children:["Validasi Pembayaran — ",s]})}),a.jsx(l,{className:"text-end",children:a.jsx(m,{color:"info",variant:"outline",onClick:v,disabled:y,children:y?a.jsxs(a.Fragment,{children:[a.jsx(w,{size:"sm",className:"me-2"})," Membuka…"]}):"Lihat Bukti Pembayaran"})})]})}),a.jsx(P,{children:a.jsxs(V,{onSubmit:S,children:[a.jsx(d,{className:"mb-3",children:a.jsxs(l,{md:6,children:[a.jsx(A,{children:"Status Validasi"}),a.jsxs(B,{value:p?"":h,onChange:t=>x(t.target.value),disabled:p,required:!0,children:[a.jsx("option",{value:"",children:"Pilih status…"}),a.jsx("option",{value:"valid",children:"Valid"}),a.jsx("option",{value:"tidak_valid",children:"Tidak Valid"})]})]})}),a.jsx(d,{children:a.jsxs(l,{className:"d-flex gap-2",children:[a.jsx(m,{type:"submit",color:"primary",disabled:j||p,children:j?a.jsxs(a.Fragment,{children:[a.jsx(w,{size:"sm",className:"me-2"})," Menyimpan…"]}):"Simpan Validasi"}),a.jsx(m,{color:"secondary",variant:"outline",onClick:()=>u("/admin"),children:"Batal"})]})}),a.jsx(d,{children:a.jsx(l,{className:"d-flex justify-content-end",children:a.jsx(m,{color:"secondary",onClick:()=>u("/admin"),children:"Kembali ke Dashboard"})})})]})})]})};export{aa as default};
